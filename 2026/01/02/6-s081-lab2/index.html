

<!DOCTYPE html>
<html lang="en" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">

  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Quan Zhou">
  <meta name="keywords" content="">
  
    <meta name="description" content="6.s081 Lab2:system calls 实现Lab2 实现了两个系统调用层面的功能，在开始写代码之前要求先读完 xv6-book 的 Chapter 2 and Sections 4.3 and 4.4 of Chapter 4，以及相关的源文件，花了两天不到的时间。 做完这次实验可以深入理解 OS 的用户态、内核态的隔离，以及系统调用。">
<meta property="og:type" content="article">
<meta property="og:title" content="6.s081 Lab2:system calls 实现">
<meta property="og:url" content="http://qizi706.github.io/2026/01/02/6-s081-lab2/index.html">
<meta property="og:site_name" content="Quan Zhou 的 blog">
<meta property="og:description" content="6.s081 Lab2:system calls 实现Lab2 实现了两个系统调用层面的功能，在开始写代码之前要求先读完 xv6-book 的 Chapter 2 and Sections 4.3 and 4.4 of Chapter 4，以及相关的源文件，花了两天不到的时间。 做完这次实验可以深入理解 OS 的用户态、内核态的隔离，以及系统调用。">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://qizi706.github.io/asserts/6-s081-lab2_assert/ecall.png">
<meta property="og:image" content="http://qizi706.github.io/asserts/6-s081-lab2_assert/trace.png">
<meta property="article:published_time" content="2026-01-02T13:05:22.000Z">
<meta property="article:modified_time" content="2026-01-03T10:59:04.321Z">
<meta property="article:author" content="Quan Zhou">
<meta property="article:tag" content="6.s081">
<meta property="article:tag" content="Labs">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://qizi706.github.io/asserts/6-s081-lab2_assert/ecall.png">
  
  
  
  <title>6.s081 Lab2:system calls 实现 - Quan Zhou 的 blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1749284_5i9bdhy70f8.css">



<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1736178_k526ubmyhba.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"qizi706.github.io","root":"/","version":"1.9.8","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false},"umami":{"src":null,"website_id":null,"domains":null,"start_time":"2024-01-01T00:00:00.000Z","token":null,"api_server":null}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 8.1.1"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Quan Zhou</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>Home</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>Archives</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>Categories</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>Tags</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>About</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="6.s081 Lab2:system calls 实现"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2026-01-02 21:05" pubdate>
          January 2, 2026 pm
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          2.5k words
        
      </span>
    

    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">6.s081 Lab2:system calls 实现</h1>
            
            
              <div class="markdown-body">
                
                <h2 id="6-s081-Lab2-system-calls-实现"><a href="#6-s081-Lab2-system-calls-实现" class="headerlink" title="6.s081 Lab2:system calls 实现"></a>6.s081 Lab2:system calls 实现</h2><p>Lab2 实现了两个系统调用层面的功能，在开始写代码之前要求先读完 <a target="_blank" rel="noopener" href="https://pdos.csail.mit.edu/6.828/2021/xv6/book-riscv-rev2.pdf">xv6-book</a> 的 Chapter 2 and Sections 4.3 and 4.4 of Chapter 4，以及相关的源文件，花了两天不到的时间。</p>
<p>做完这次实验可以深入理解 OS 的用户态、内核态的隔离，以及系统调用。</p>
<span id="more"></span>

<p>实现了两个简单的系统调用：</p>
<h3 id="0-前言：系统调用的过程"><a href="#0-前言：系统调用的过程" class="headerlink" title="0. 前言：系统调用的过程"></a>0. 前言：系统调用的过程</h3><p>这是一个从 <strong>用户态（User Space）</strong> 跨越到 <strong>内核态（Kernel Space）</strong> 最后返回用户程序继续执行的过程，流程非常严谨，主要分为以下 5 个关键阶段:</p>
<h4 id="第一阶段：用户态准备（User-Space）"><a href="#第一阶段：用户态准备（User-Space）" class="headerlink" title="第一阶段：用户态准备（User Space）"></a>第一阶段：用户态准备（User Space）</h4><ol>
<li><p><strong>C 函数调用</strong>：在用户态执行会引发系统调用的指令，比如 <code>trace(mask)</code> 或 <code>sysinfo(&amp;info)</code> ，编译器会去寻找它的定义。</p>
</li>
<li><p><strong>存根（Stub）</strong> <code>usys.S</code>：修改的 <code>usys.pl</code> 会生成 <code>usys.S</code> 汇编代码，这是真正的入口：</p>
</li>
</ol>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs perl"><span class="hljs-keyword">print</span> <span class="hljs-string">&quot;# generated by usys.pl - do not edit\n&quot;</span>;<br><br><span class="hljs-keyword">print</span> <span class="hljs-string">&quot;#include \&quot;kernel/syscall.h\&quot;\n&quot;</span>;<br><br><span class="hljs-function"><span class="hljs-keyword">sub</span> <span class="hljs-title">entry</span> </span>&#123;<br>    <span class="hljs-keyword">my</span> <span class="hljs-variable">$name</span> = <span class="hljs-keyword">shift</span>;<br>    <span class="hljs-keyword">print</span> <span class="hljs-string">&quot;.global <span class="hljs-variable">$name</span>\n&quot;</span>;<br>    <span class="hljs-keyword">print</span> <span class="hljs-string">&quot;<span class="hljs-subst">$&#123;name&#125;</span>:\n&quot;</span>;<br>    <span class="hljs-keyword">print</span> <span class="hljs-string">&quot; li a7, SYS_<span class="hljs-subst">$&#123;name&#125;</span>\n&quot;</span>;<br>    <span class="hljs-keyword">print</span> <span class="hljs-string">&quot; ecall\n&quot;</span>;<br>    <span class="hljs-keyword">print</span> <span class="hljs-string">&quot; ret\n&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li><code>a7</code> <strong>寄存器</strong>：存储系统调用号，内核只会看这个寄存器来知道你想要干什么。</li>
<li><code>ecall</code> <strong>指令</strong>：这是 CPU 的硬件指令，一旦执行，CPU 权限就会从 User Mode 提升到 Supervisor Mode。</li>
</ul>
<h4 id="第二阶段：跨越边界（The-Trap）"><a href="#第二阶段：跨越边界（The-Trap）" class="headerlink" title="第二阶段：跨越边界（The Trap）"></a>第二阶段：跨越边界（The Trap）</h4><p><code>ecall</code> 执行的瞬间，硬件接管了控制权，发生了以下改变：</p>
<p><img src="/asserts/6-s081-lab2_assert/ecall.png" srcset="/img/loading.gif" lazyload alt="xv-book-ecall"></p>
<ol>
<li><p><strong>跳转</strong>：CPU 读取 <code>stvec</code> 寄存器（里面存着内核入口位置），跳转到 <code>trampoline.S</code> 中的 <code>uservec</code> 代码段。</p>
</li>
<li><p><strong>权限提升</strong>：现在的代码实在 Supervisor Mode 下运行的。</p>
</li>
</ol>
<h4 id="第三阶段：蹦床机制（Trampoline）"><a href="#第三阶段：蹦床机制（Trampoline）" class="headerlink" title="第三阶段：蹦床机制（Trampoline）"></a>第三阶段：蹦床机制（Trampoline）</h4><p>此时内存页表（Page Table）还是用户进程的页表，内核代码大部分是看不见的。</p>
<ol>
<li><p><strong>保存现场（<code>uservec</code>）</strong>：在 <code>trampoline.S</code> 中，代码把所有用户寄存器中的内容（a0, a1, sp, pc 等）都保存到 <code>p-&gt;trapframe</code> 结构体中，以便之后还可以返回用户程序继续运行。</p>
</li>
<li><p><strong>切换页表</strong>：代码修改 <code>satp</code> 寄存器，从用户页表切换到内核页表，此时内核才能真正访问内核内存空间。</p>
</li>
<li><p><strong>跳转到 C 代码</strong>：最后跳转到 <code>trap.c</code> 中的 <code>usertrap()</code> 函数。</p>
</li>
</ol>
<h4 id="第四阶段：分发与执行（Kernel-Space）"><a href="#第四阶段：分发与执行（Kernel-Space）" class="headerlink" title="第四阶段：分发与执行（Kernel Space）"></a>第四阶段：分发与执行（Kernel Space）</h4><p>现在安全地在内核 C 环境中了。</p>
<ol>
<li><p><code>usertrap()</code>：它主要检查发生异常的原因（<code>scause</code> 寄存器），根据寄存器中的 8 判断是系统调用引发异常。</p>
</li>
<li><p><code>syscall()</code>：从保存的上下文（<code>trapframe-&gt;a7</code>）中取出中断号。</p>
</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c">num = p-&gt;trapframe-&gt;a7;<br><span class="hljs-keyword">if</span>(num &gt; <span class="hljs-number">0</span> &amp;&amp; num &lt; NELEM(syscalls) &amp;&amp; syscalls[num]) &#123;<br>  p-&gt;trapframe-&gt;a0 = syscalls[num]();<br>&#125;<br></code></pre></td></tr></table></figure>

<ol>
<li>执行系统调用处理函数：这里设计我们实现的系统调用函数以及 xv6 原本已经实现好的系统调用函数，执行这些函数。</li>
</ol>
<h4 id="第五阶段：返回（Return）"><a href="#第五阶段：返回（Return）" class="headerlink" title="第五阶段：返回（Return）"></a>第五阶段：返回（Return）</h4><p>任务完成，要返回用户程序继续执行。</p>
<ol>
<li><p><strong>设置返回值</strong>：刚刚的 <code>syscall()</code> 中已经将系统调用函数的返回值存进了 <code>p-&gt;trapframe-&gt;a0</code> 中，在 RISC—V 中 a0 寄存器用于存放返回值。</p>
</li>
<li><p><code>usertrapret()</code>：关中断，准备返回用户态，设置 <code>stvec</code> 指向 <code>trampoline</code> 以便下次系统调用能找回来。</p>
</li>
<li><p><code>userret</code>：再次切换页表（内核页表-&gt;用户页表）。把 <code>trapframe</code> 中保存的寄存器值全部恢复到 CPU 中。</p>
</li>
<li><p><code>sret</code>：这是 <code>ecall</code> 的逆操作，可以从 Supervisor Mode 返回 User Mode，PC 中的值恢复到刚刚产生异常时应该执行的下一行代码（这里会根据异常种类的不同而指向原本引发中断的代码或原本引发中段的下一行代码。与操作系统理论课中学过的内容一致）。</p>
</li>
</ol>
<h3 id="1-System-call-tracing-moderate"><a href="#1-System-call-tracing-moderate" class="headerlink" title="1. System call tracing (moderate)"></a>1. System call tracing (<u>moderate</u>)</h3><p>实现一个根据掩码（mask）对系统调用进行追踪的系统调用，使用 <code>trace</code> 指令后会发出一个系统调用，例如 <code>trace(1 &lt;&lt; SYS_fork)</code> 就可以对 <code>fork</code> 这个系统调用进行追踪，返回所追踪的系统调用的 pid、系统调用名以及返回值（如下图），对后续的 debug 过程有一定帮助。</p>
<p><img src="/asserts/6-s081-lab2_assert/trace.png" srcset="/img/loading.gif" lazyload alt="trace"></p>
<p>根据上面提到的系统调用的过程，如果想要为操作系统添加一个系统调用，需要进行以下步骤：</p>
<h4 id="添加系统调用存根（Stub）"><a href="#添加系统调用存根（Stub）" class="headerlink" title="添加系统调用存根（Stub）"></a>添加系统调用存根（Stub）</h4><p>修改 <code>user/usys.pl</code></p>
<figure class="highlight perl"><figcaption><span>user/usys.pl</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs perl"><span class="hljs-comment"># ...</span><br>entry(<span class="hljs-string">&quot;trace&quot;</span>);<br><span class="hljs-comment"># ...</span><br></code></pre></td></tr></table></figure>

<h4 id="添加函数签名"><a href="#添加函数签名" class="headerlink" title="添加函数签名"></a>添加函数签名</h4><p>我们会在用户程序中使用系统调用函数，因此要修改 <code>user/user.h</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// system calls</span><br><span class="hljs-comment">// ...</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">trace</span><span class="hljs-params">(<span class="hljs-type">int</span>)</span>;<br><span class="hljs-comment">// ...</span><br></code></pre></td></tr></table></figure>

<h4 id="添加系统调用"><a href="#添加系统调用" class="headerlink" title="添加系统调用"></a>添加系统调用</h4><p>在 <code>kernel/syscall.h</code> 中添加一个系统调用号的宏定义:</p>
<p>系统调用号唯一，这里要不同于之前的系统调用号。</p>
<figure class="highlight c"><figcaption><span>kernel/syscall.h</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// ...</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SYS_trace  22</span><br><span class="hljs-comment">// ...</span><br></code></pre></td></tr></table></figure>

<p>修改 <code>kernel/syscall.c</code> 中的一些静态变量:</p>
<ul>
<li>申明全局系统调用函数:</li>
</ul>
<figure class="highlight c"><figcaption><span>kernel/syscall.c</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// ...</span><br><span class="hljs-keyword">extern</span> uint64 <span class="hljs-title function_">sys_trace</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>;<br><span class="hljs-comment">// ...</span><br></code></pre></td></tr></table></figure>

<ul>
<li>添加 <code>syscalls</code>，目的是通过系统调用好能够找到对应的系统调用：</li>
</ul>
<figure class="highlight c"><figcaption><span>kernel/syscall.c</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><br><span class="hljs-type">static</span> <span class="hljs-title function_">uint64</span> <span class="hljs-params">(*syscalls[])</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> = &#123;<br><span class="hljs-comment">// ...</span><br>[SYS_trace]   = sys_trace,<br><span class="hljs-comment">// ...</span><br>&#125;;<br><br></code></pre></td></tr></table></figure>

<ul>
<li>新增一个 <code>syscall_names</code> 静态数组用于将系统调用号映射为相应系统调用名:</li>
</ul>
<figure class="highlight c"><figcaption><span>kernel/syscall.c</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">char</span> *syscall_names[] = &#123;<br>  [SYS_fork]    = <span class="hljs-string">&quot;fork&quot;</span>,<br>  [SYS_exit]    = <span class="hljs-string">&quot;exit&quot;</span>,<br>  [SYS_wait]    = <span class="hljs-string">&quot;wait&quot;</span>,<br>  [SYS_pipe]    = <span class="hljs-string">&quot;pipe&quot;</span>,<br>  [SYS_read]    = <span class="hljs-string">&quot;read&quot;</span>,<br>  [SYS_kill]    = <span class="hljs-string">&quot;kill&quot;</span>,<br>  [SYS_exec]    = <span class="hljs-string">&quot;exec&quot;</span>,<br>  [SYS_fstat]   = <span class="hljs-string">&quot;fstat&quot;</span>,<br>  [SYS_chdir]   = <span class="hljs-string">&quot;chdir&quot;</span>,<br>  [SYS_dup]     = <span class="hljs-string">&quot;dup&quot;</span>,<br>  [SYS_getpid]  = <span class="hljs-string">&quot;getpid&quot;</span>,<br>  [SYS_sbrk]    = <span class="hljs-string">&quot;sbrk&quot;</span>,<br>  [SYS_sleep]   = <span class="hljs-string">&quot;sleep&quot;</span>,<br>  [SYS_uptime]  = <span class="hljs-string">&quot;uptime&quot;</span>,<br>  [SYS_open]    = <span class="hljs-string">&quot;open&quot;</span>,<br>  [SYS_write]   = <span class="hljs-string">&quot;write&quot;</span>,<br>  [SYS_mknod]   = <span class="hljs-string">&quot;mknod&quot;</span>,<br>  [SYS_unlink]  = <span class="hljs-string">&quot;unlink&quot;</span>,<br>  [SYS_link]    = <span class="hljs-string">&quot;link&quot;</span>,<br>  [SYS_mkdir]   = <span class="hljs-string">&quot;mkdir&quot;</span>,<br>  [SYS_close]   = <span class="hljs-string">&quot;close&quot;</span>,<br>  [SYS_trace]   = <span class="hljs-string">&quot;trace&quot;</span>,<br>  [SYS_sysinfo] = <span class="hljs-string">&quot;sysinfo&quot;</span>,<br>&#125;;<br></code></pre></td></tr></table></figure>

<h4 id="实现-trace-系统调用"><a href="#实现-trace-系统调用" class="headerlink" title="实现 trace 系统调用"></a>实现 <code>trace</code> 系统调用</h4><p>首先添加实现 <code>trace</code> 必要的额外变量：</p>
<figure class="highlight c"><figcaption><span>kernel/proc.h</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">proc</span> &#123;</span><br>  <span class="hljs-comment">// ...</span><br>  <span class="hljs-type">int</span> trace_mask;<br>&#125;;<br></code></pre></td></tr></table></figure>

<p>这个变量用于在进程中存储 <code>trace</code> 的掩码。</p>
<p>系统调用的实现都在 <code>kernel/sysproc.c</code> 中，因此在这个文件中添加一个函数 <code>sys_trace</code>，与上面的 <code>syscalls</code> 中添加的函数名一致。</p>
<figure class="highlight c"><figcaption><span>kernel/sysproc.c</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c">uint64<br><span class="hljs-title function_">sys_trace</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>  <span class="hljs-type">int</span> mask;<br><br>  <span class="hljs-keyword">if</span>(argint(<span class="hljs-number">0</span>, &amp;mask) &lt; <span class="hljs-number">0</span>)<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>  myproc()-&gt;trace_mask = mask;<br><br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>其中 <code>argint</code> 函数用于获取引发系统调用的函数中的参数，这里为 <code>trace</code> 所需要的掩码，获取到后将其存放到当前进程的 <code>proc</code> 状态结构体中。</p>
<p>这里这个系统调用完成的事情已经做完了，但是想要能够监测系统调用，还需要在 <code>syscall()</code> 函数中添加几行代码将检测到的内容输出:</p>
<figure class="highlight c"><figcaption><span>kernel/syscall.c</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span><br><span class="hljs-title function_">syscall</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>  <span class="hljs-type">int</span> num;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">proc</span> *<span class="hljs-title">p</span> =</span> myproc();<br><br>  num = p-&gt;trapframe-&gt;a7;<br>  <span class="hljs-keyword">if</span>(num &gt; <span class="hljs-number">0</span> &amp;&amp; num &lt; NELEM(syscalls) &amp;&amp; syscalls[num]) &#123;<br>    p-&gt;trapframe-&gt;a0 = syscalls[num]();<br><br>    <span class="hljs-keyword">if</span> ((p-&gt;trace_mask &gt;&gt; num) &amp; <span class="hljs-number">1</span>) &#123;<br>      <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%d: syscall %s -&gt; %d\n&quot;</span>,<br>             p-&gt;pid,<br>             syscall_names[p-&gt;trapframe-&gt;a7],<br>             p-&gt;trapframe-&gt;a0);<br>    &#125;<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%d %s: unknown sys call %d\n&quot;</span>,<br>            p-&gt;pid, p-&gt;name, num);<br>    p-&gt;trapframe-&gt;a0 = <span class="hljs-number">-1</span>;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="2-Sysinfo-moderate"><a href="#2-Sysinfo-moderate" class="headerlink" title="2. Sysinfo (moderate)"></a>2. Sysinfo (<u>moderate</u>)</h3><p>这个系统调用的功能更是收集这个正在运行的系统的信息。<code>sysinfo</code> 接收一个指向 <code>struct sysinfo</code> 的指针作为参数，内核应该填充这个结构体的各个字段：</p>
<ul>
<li><code>freemem</code> ：内存空闲的字节数</li>
<li><code>nproc</code>：<code>state</code> 不为 UNUSED 的进程数（也就是正在运行的进程数）</li>
</ul>
<p>基本系统调用需要添加的内容与上一个任务一样，除此之外这个实现中涉及内核态向用户态传递内核的一些数据，这就是这个任务的唯一难题了。</p>
<p>先观察一下 <code>struct sysinfo</code>：</p>
<figure class="highlight c"><figcaption><span>kernel/sysinfo.h</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sysinfo</span> &#123;</span><br>  uint64 freemem;   <span class="hljs-comment">// amount of free memory (bytes)</span><br>  uint64 nproc;     <span class="hljs-comment">// number of process</span><br>&#125;;<br></code></pre></td></tr></table></figure>

<p>主要就是两个 uint64 字段，因此只要获取到这两个字段的内容就好了。</p>
<p>题目给出的提示中说参考 sys_fstat() 函数以及 filestat() 函数，就是告诉我们如何从内核中向用户空间中写入数据。</p>
<p>这两段代码演示了两个重要的函数： argaddr 以及 copyout。这两个函数在 xv6-book 中已有介绍：</p>
<ul>
<li>argaddr：与 argint&#x2F;argfd 类似，获取第 n 个系统调用函数作为（地址&#x2F;整数&#x2F;文件描述符）。</li>
</ul>
<blockquote>
<p>The kernel functions argint, argaddr, and argfd retrieve the n ’th system call argument from the trap frame as an integer, pointer, or a file descriptor.</p>
</blockquote>
<ul>
<li>copyout：从内核空间中拷贝数据到用户提供的地址（这里的地址是用户页表下的虚拟地址，因此可以防止攻击其他的用户进程）。</li>
</ul>
<blockquote>
<p>copyinstr (kernel&#x2F;vm.c:403) copies up to max bytes to dst from virtual address srcva in the user page table pagetable. … A similar function, copyout, copies data from the kernel to a user-supplied address.</p>
</blockquote>
<p>了解了上面的内容后 sys_sysinfo 的实现只需要获取到<strong>空闲内存</strong>以及<strong>进程数</strong>了，还需要写两个函数： kcollect_freemem 以及 collect_nproc。</p>
<figure class="highlight c"><figcaption><span>kernel kalloc.c</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c">uint64<br><span class="hljs-title function_">kcollect_freemem</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">run</span> *<span class="hljs-title">r</span>;</span><br>  uint64 n = <span class="hljs-number">0</span>;<br><br>  acquire(&amp;kmem.lock);<br>  r = kmem.freelist;<br><br>  <span class="hljs-keyword">while</span> (r) &#123;<br>    n++;<br>    r = r-&gt;next;<br>  &#125;<br>  release(&amp;kmem.lock);<br><br>  <span class="hljs-keyword">return</span> n * PGSIZE;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>kcollect_freemem 函数访问 kmem 结构体，其中有两个内容：一个结构体的锁和空闲物理内存链表的表头指针。</p>
<figure class="highlight c"><figcaption><span>kernel/kalloc.c</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spinlock</span> <span class="hljs-title">lock</span>;</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">run</span> *<span class="hljs-title">freelist</span>;</span><br>&#125; kmem;<br></code></pre></td></tr></table></figure>

<p>这里的自旋锁不做过多解释，后面会有 lab 详细涉及，这里只需要获取和释放就行了。</p>
<p>freelist 是利用了页表的前 8 个字节作为指针指向下一个页表的起始地址，因此只需要不断遍历链表就可以获取空闲页表的数量，在这个基础上乘以页表大小就可以获取到 freemem。因此 kcollect_freemem 函数实现如下：</p>
<figure class="highlight c"><figcaption><span>kernel/kalloc.c</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c">uint64<br><span class="hljs-title function_">kcollect_freemem</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">run</span> *<span class="hljs-title">r</span>;</span><br>  uint64 n = <span class="hljs-number">0</span>;<br><br>  acquire(&amp;kmem.lock);<br>  r = kmem.freelist;<br><br>  <span class="hljs-keyword">while</span> (r) &#123;<br>    n++;<br>    r = r-&gt;next;<br>  &#125;<br>  release(&amp;kmem.lock);<br><br>  <span class="hljs-keyword">return</span> n * PGSIZE;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>接下来实现 collect_nproc 函数只需要遍历一下 kernel&#x2F;proc.c 中的 proc 数组，统计有多少个 p-&gt;state 不为 UNUSED 即可：</p>
<figure class="highlight c"><figcaption><span>kernel/proc.c</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c">uint64<br><span class="hljs-title function_">collect_nproc</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">proc</span> *<span class="hljs-title">p</span>;</span><br>  uint64 n = <span class="hljs-number">0</span>;<br><br>  <span class="hljs-keyword">for</span> (p = proc; p &lt; &amp;proc[NPROC]; p++) &#123;<br>    <span class="hljs-keyword">if</span> (p-&gt;state != UNUSED)<br>      n++;<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> n;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>最后实现一下 sys_sysinfo 系统调用函数，使用 argaddr 和 copyout 将以上函数获取到的信息写入用户空间中：</p>
<figure class="highlight c"><figcaption><span>kernel.sysproc.c</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c">uint64<br><span class="hljs-title function_">sys_sysinfo</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>  uint64 addr;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sysinfo</span> <span class="hljs-title">info</span>;</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">proc</span> *<span class="hljs-title">p</span> =</span> myproc();<br><br>  <span class="hljs-keyword">if</span> (argaddr(<span class="hljs-number">0</span>, &amp;addr) &lt; <span class="hljs-number">0</span>) <br>    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br><br>  info.freemem = kcollect_freemem();<br>  info.nproc = collect_nproc();<br><br>  <span class="hljs-keyword">if</span> (copyout(p-&gt;pagetable, addr, (<span class="hljs-type">char</span> *)&amp;info, <span class="hljs-keyword">sizeof</span>(info)) &lt; <span class="hljs-number">0</span>)<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br><br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>以上就是 Lab2 的所有内容，完成这个需要理解也会加深理解对操作系统的系统调用相关的知识。</p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/OS/" class="category-chain-item">OS</a>
  
  

      </span>
    
  
    
      <span class="category-chain">
        
  <a href="/categories/MIT-courses/" class="category-chain-item">MIT courses</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/6-s081/" class="print-no-link">#6.s081</a>
      
        <a href="/tags/Labs/" class="print-no-link">#Labs</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>6.s081 Lab2:system calls 实现</div>
      <div>http://qizi706.github.io/2026/01/02/6-s081-lab2/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>Author</div>
          <div>Quan Zhou</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>Posted on</div>
          <div>January 2, 2026</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>Licensed under</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - Attribution">
                    <i class="iconfont icon-cc-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2025/12/30/6-s081-lab1/" title="6.s081 Lab1:Xv6 and Unix utilities 实现">
                        <span class="hidden-mobile">6.s081 Lab1:Xv6 and Unix utilities 实现</span>
                        <span class="visible-mobile">Next</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>Table of Contents</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Search</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">Keyword</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
      <a href="https://github.com/qizi706" target="_blank" rel="nofollow noopener"><span>Quan Zhou</span></a>
    </div>
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/5.0.0/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">Blog works best with JavaScript enabled</div>
  </noscript>
</body>
</html>
