<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>6.s081-lab1记录</title>
    <link href="/2025/12/30/6-s081-lab1/"/>
    <url>/2025/12/30/6-s081-lab1/</url>
    
    <content type="html"><![CDATA[<h2 id="6-s081-Lab1-Xv6-and-Unix-utilities-实现"><a href="#6-s081-Lab1-Xv6-and-Unix-utilities-实现" class="headerlink" title="6.s081 Lab1:Xv6 and Unix utilities 实现"></a>6.s081 Lab1:Xv6 and Unix utilities 实现</h2><h3 id="1-sleep-easy"><a href="#1-sleep-easy" class="headerlink" title="1.sleep(easy)"></a>1.sleep(<u>easy</u>)</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;kernel/types.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;user/user.h&quot;</span></span><br><br><span class="hljs-type">int</span><br><span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> *argv[])</span> <br>&#123;<br>  <span class="hljs-keyword">if</span> (argc != <span class="hljs-number">2</span>) &#123;<br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-number">2</span>, <span class="hljs-string">&quot;Usage: sleep &lt;ticks&gt;\n&quot;</span>);<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>  &#125;<br><br>  <span class="hljs-type">int</span> ticks = atoi(argv[<span class="hljs-number">1</span>]);<br>  <span class="hljs-keyword">if</span> (sleep(ticks) &lt; <span class="hljs-number">0</span>) &#123;<br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-number">2</span>, <span class="hljs-string">&quot;sleep: system call failed\n&quot;</span>);<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>  &#125;<br><br>  <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>主要考察对一些基本系统调用的使用，这里使用了 sleep 系统调用，传入一个参数 tick 作为 sleep 的时间，fprintf 中的第一个参数2表示在 qemu 的终端中输出，如果系统调用错误就 exit 1，否则程序将在 sleep 后退出。</p><h3 id="2-pingpong-easy"><a href="#2-pingpong-easy" class="headerlink" title="2.pingpong(easy)"></a>2.pingpong(<u>easy</u>)</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;kernel/types.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;user/user.h&quot;</span></span><br><br><br><span class="hljs-type">int</span><br><span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> *argv[])</span> <br>&#123;<br>  <span class="hljs-type">int</span> p1[<span class="hljs-number">2</span>];<br>  <span class="hljs-type">int</span> p2[<span class="hljs-number">2</span>];<br>  <span class="hljs-type">char</span> buf;<br>  <span class="hljs-keyword">if</span> (pipe(p1) &lt; <span class="hljs-number">0</span> || pipe(p2) &lt; <span class="hljs-number">0</span>) &#123;<br>      <span class="hljs-built_in">fprintf</span>(<span class="hljs-number">2</span>, <span class="hljs-string">&quot;pipe() failed\n&quot;</span>);<br>      <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>  &#125;<br><br>  <span class="hljs-type">int</span> pid = fork();<br><br>  <span class="hljs-keyword">if</span> (pid &lt; <span class="hljs-number">0</span>) &#123;<br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-number">2</span>, <span class="hljs-string">&quot;fork: system call failed\n&quot;</span>);<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>  &#125;<br><br>  <span class="hljs-keyword">if</span> (pid == <span class="hljs-number">0</span>) &#123;<br>    close(p1[<span class="hljs-number">1</span>]);<br>    close(p2[<span class="hljs-number">0</span>]);<br><br>    <span class="hljs-keyword">if</span> (read(p1[<span class="hljs-number">0</span>], &amp;buf, <span class="hljs-number">1</span>) &lt; <span class="hljs-number">0</span>) &#123;<br>      <span class="hljs-built_in">fprintf</span>(<span class="hljs-number">2</span>, <span class="hljs-string">&quot;read: system call failed\n&quot;</span>);<br>      <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>    &#125;<br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-number">2</span>, <span class="hljs-string">&quot;%d: received ping\n&quot;</span>, getpid());<br><br>    <span class="hljs-keyword">if</span> (write(p2[<span class="hljs-number">1</span>], <span class="hljs-string">&quot;x&quot;</span>, <span class="hljs-number">1</span>) != <span class="hljs-number">1</span>) &#123;<br>      <span class="hljs-built_in">fprintf</span>(<span class="hljs-number">2</span>, <span class="hljs-string">&quot;write: system call failed\n&quot;</span>);<br>      <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>    &#125;<br><br>    close(p1[<span class="hljs-number">0</span>]);<br>    close(p2[<span class="hljs-number">1</span>]);<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-keyword">if</span> (write(p1[<span class="hljs-number">1</span>], <span class="hljs-string">&quot;x&quot;</span>, <span class="hljs-number">1</span>) != <span class="hljs-number">1</span>) &#123;<br>      <span class="hljs-built_in">fprintf</span>(<span class="hljs-number">2</span>, <span class="hljs-string">&quot;write: system call failed\n&quot;</span>);<br>      <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>    &#125;<br>    <span class="hljs-keyword">if</span> (read(p2[<span class="hljs-number">0</span>], &amp;buf, <span class="hljs-number">1</span>) &lt; <span class="hljs-number">0</span>) &#123;<br>      <span class="hljs-built_in">fprintf</span>(<span class="hljs-number">2</span>, <span class="hljs-string">&quot;read: system call failed\n&quot;</span>);<br>      <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>    &#125;<br><br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-number">2</span>, <span class="hljs-string">&quot;%d: received pong\n&quot;</span>, getpid());<br>  &#125; <br>  <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>考察对 pipe 以及 fork 的使用。</p><p>pipe 系统调用创建一个管道，参数为长度为 2 的数组，数组下标 0 为管道读端，下标 1 为管道写端。创建后可以使用 write 和 read 进行进程间通信。</p><p>fork 系统调用创建一个和当前进程（几乎）完全相同的子进程，并且子进程有自己的内存空间，内存变量不共享，而是复制了一份，但文件描述项目表中的指针是共享的，比如这里的管道。创建的新进程同样会有 fork 的返回值，fork 函数在不同进程的返回值不同，在父进程中返回值为新创建的子进程的 pid ，而在新创建的子进程中返回0，这可以作为区分两个进程的方法。</p><p>也讲一下 read 和 write 系统调用的使用, read 接收3个参数，分别为读取文件的描述符fd、有效的内存地址用于存储读取到的内容、希望读取的长度（以字节为单位），同理 write 是将内存地址中向文件描述符指向的文件中写入，它们的返回值有三种:</p><ol><li><code>&gt; 0</code>: <strong>成功</strong>，返回读取到的字节数。</li><li><code>= 0</code>: <strong>EOF</strong>，表示文件读完了，也可能是在读管道时发现管道中已经没有数据，这是循环读取时的退出标志。</li><li><code>-1</code>: <strong>出错</strong>，比如 fd 无效，或传入了非法地址。</li></ol><p><strong>注意：</strong> write 系统调用很少返回 0，只有当 <code>write(fd, &amp;buf, 0)</code> 才可能返回 0。如果在写管道时发现读端被关闭了，那么会触发<code>SIGPIPE</code>，通常导致进程直接被杀死。如果忽略信号，则返回 -1，在 xv6 中这种情况会直接返回 -1。</p><h3 id="3-primes-moderate-hard"><a href="#3-primes-moderate-hard" class="headerlink" title="3. primes(moderate)&#x2F;(hard)"></a>3. primes(<u>moderate</u>)&#x2F;(<u>hard</u>)</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;kernel/types.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;user/user.h&quot;</span></span><br><br><span class="hljs-type">void</span><br><span class="hljs-title function_">sieve</span><span class="hljs-params">(<span class="hljs-type">int</span> pleft[<span class="hljs-number">2</span>])</span> <br>&#123;<br>  <span class="hljs-type">int</span> pright[<span class="hljs-number">2</span>];<br>  <span class="hljs-type">int</span> prime;<br>  <span class="hljs-type">int</span> n;<br><br>  close(pleft[<span class="hljs-number">1</span>]); <span class="hljs-comment">// close write end of pleft</span><br><br>  <span class="hljs-keyword">if</span> (read(pleft[<span class="hljs-number">0</span>], &amp;prime, <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">int</span>)) == <span class="hljs-number">0</span>) &#123;<br>    close(pleft[<span class="hljs-number">0</span>]);<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>  &#125;<br><br>  <span class="hljs-built_in">fprintf</span>(<span class="hljs-number">2</span>, <span class="hljs-string">&quot;prime %d\n&quot;</span>, prime);<br>  pipe(pright);<br><br>  <span class="hljs-keyword">if</span> (fork() == <span class="hljs-number">0</span>) &#123;<br>    sieve(pright);<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    close(pright[<span class="hljs-number">0</span>]);<br><br>    <span class="hljs-keyword">while</span> (read(pleft[<span class="hljs-number">0</span>], &amp;n, <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">int</span>)) != <span class="hljs-number">0</span>) &#123;<br>      <span class="hljs-keyword">if</span> (n % prime != <span class="hljs-number">0</span>) &#123;<br>        write(pright[<span class="hljs-number">1</span>], &amp;n, <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">int</span>));<br>      &#125;<br>    &#125;<br>  &#125;<br><br>  close(pleft[<span class="hljs-number">0</span>]);<br>  close(pright[<span class="hljs-number">1</span>]);<br>  wait(<span class="hljs-number">0</span>);<br>  <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>&#125;<br><br><span class="hljs-type">int</span><br><span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> *argv[])</span> <br>&#123;<br>  <span class="hljs-type">int</span> p[<span class="hljs-number">2</span>];<br>  pipe(p);<br><br>  <span class="hljs-keyword">if</span> (fork() == <span class="hljs-number">0</span>) &#123;<br>    sieve(p);<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    close(p[<span class="hljs-number">0</span>]);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">2</span>; i &lt;= <span class="hljs-number">35</span>; i++) &#123;<br>      write(p[<span class="hljs-number">1</span>], &amp;i, <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">int</span>));<br>    &#125;<br>    close(p[<span class="hljs-number">1</span>]);<br><br>    wait(<span class="hljs-number">0</span>);<br>  &#125;<br>  <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>用管道写一个并发的埃拉托斯特尼筛（sieve of Eratosthenes），用来筛出 35 以内的所有质数 <a href="https://swtch.com/~rsc/thread/">参考文章</a>，思想就是每个进程从左边接收一些数，输出第一个数（此数必为质数），然后将剩下的接收到的所有不能被该质数整除的数依次发送给下一个进程，直至结束。</p><p>这里用到了一个 sieve 递归函数，首先处理一下管道，输出第一个接收到的数，同时也是递归出口，如果 read 管道返回0的话就代表着所有的数已经处理完毕，直接退出。否则就使用 fork 调用创建一个新进程，当前进程把剩下的不能被质数整除的数通过管道发送给子进程，然后等待子进程结束。子进程递归调用 sieve 函数……</p><p>其中 main 函数作为入口，初始化一个管道后把所有的数全部发送给子进程，子进程开始调用 sieve 。</p><p>我认为这个的难度应该只是 moderate，并非到 hard 的程度。</p><h3 id="4-find-moderate"><a href="#4-find-moderate" class="headerlink" title="4. find(moderate)"></a>4. find(<u>moderate</u>)</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;kernel/types.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;kernel/stat.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;user/user.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;kernel/fs.h&quot;</span></span><br><br><span class="hljs-type">char</span>*<br><span class="hljs-title function_">getname</span><span class="hljs-params">(<span class="hljs-type">char</span> *path)</span><br>&#123;<br>  <span class="hljs-type">static</span> <span class="hljs-type">char</span> buf[DIRSIZ+<span class="hljs-number">1</span>];<br>  <span class="hljs-type">char</span> *p;<br><br>  <span class="hljs-comment">// Find first character after last slash.</span><br>  <span class="hljs-keyword">for</span>(p=path+<span class="hljs-built_in">strlen</span>(path); p &gt;= path &amp;&amp; *p != <span class="hljs-string">&#x27;/&#x27;</span>; p--)<br>    ;<br>  p++;<br><br>  <span class="hljs-keyword">if</span>(<span class="hljs-built_in">strlen</span>(p) &gt;= DIRSIZ)<br>    <span class="hljs-keyword">return</span> p;<br>  memmove(buf, p, <span class="hljs-built_in">strlen</span>(p));<br>  buf[<span class="hljs-built_in">strlen</span>(p)] = <span class="hljs-number">0</span>;<br>  <span class="hljs-keyword">return</span> buf;<br>&#125;<br><br><span class="hljs-type">void</span><br><span class="hljs-title function_">find</span><span class="hljs-params">(<span class="hljs-type">char</span> *path, <span class="hljs-type">char</span> *target)</span> <br>&#123;<br>  <span class="hljs-type">char</span> buf[<span class="hljs-number">512</span>], *p;<br>  <span class="hljs-type">int</span> fd;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">dirent</span> <span class="hljs-title">de</span>;</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">stat</span> <span class="hljs-title">st</span>;</span><br><br>  <span class="hljs-keyword">if</span> ((fd = open(path, <span class="hljs-number">0</span>)) &lt; <span class="hljs-number">0</span>) &#123;<br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-number">2</span>, <span class="hljs-string">&quot;find: cannot open %s\n&quot;</span>, path);<br>    <span class="hljs-keyword">return</span>;<br>  &#125;<br><br>  <span class="hljs-keyword">if</span>(fstat(fd, &amp;st) &lt; <span class="hljs-number">0</span>)&#123;<br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-number">2</span>, <span class="hljs-string">&quot;find: cannot stat %s\n&quot;</span>, path);<br>    close(fd);<br>    <span class="hljs-keyword">return</span>;<br>  &#125;<br><br>  <span class="hljs-keyword">switch</span> (st.type) &#123;<br>  <span class="hljs-keyword">case</span> T_FILE:<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(getname(path), target) == <span class="hljs-number">0</span>) &#123;<br>      <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%s\n&quot;</span>, path);<br>    &#125;<br>    <span class="hljs-keyword">break</span>;<br>  <span class="hljs-keyword">case</span> T_DIR:<br>    <span class="hljs-keyword">if</span>(<span class="hljs-built_in">strlen</span>(path) + <span class="hljs-number">1</span> + DIRSIZ + <span class="hljs-number">1</span> &gt; <span class="hljs-keyword">sizeof</span> buf)&#123;<br>      <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;find: path too long\n&quot;</span>);<br>      <span class="hljs-keyword">break</span>;<br>    &#125;<br>    <span class="hljs-built_in">strcpy</span>(buf, path);<br>    p = buf + <span class="hljs-built_in">strlen</span>(buf);<br>    *p++ = <span class="hljs-string">&#x27;/&#x27;</span>;<br>    <span class="hljs-keyword">while</span>(read(fd, &amp;de, <span class="hljs-keyword">sizeof</span>(de)) == <span class="hljs-keyword">sizeof</span>(de))&#123;<br>      <span class="hljs-keyword">if</span>(de.inum == <span class="hljs-number">0</span>)<br>        <span class="hljs-keyword">continue</span>;<br>      <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(de.name, <span class="hljs-string">&quot;.&quot;</span>) == <span class="hljs-number">0</span> || <span class="hljs-built_in">strcmp</span>(de.name, <span class="hljs-string">&quot;..&quot;</span>) == <span class="hljs-number">0</span>) &#123;<br>          <span class="hljs-keyword">continue</span>;<br>      &#125;<br>      memmove(p, de.name, DIRSIZ);<br>      p[DIRSIZ] = <span class="hljs-number">0</span>;<br>      find(buf, target);<br>    &#125;<br>  &#125;<br><br>  close(fd);<br>&#125;<br><br><span class="hljs-type">int</span><br><span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> *argv[])</span><br>&#123;<br>  <span class="hljs-keyword">if</span> (argc != <span class="hljs-number">3</span>) &#123;<br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-number">2</span>, <span class="hljs-string">&quot;Usage: find &lt;path&gt; &lt;name&gt;\n&quot;</span>);<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>  &#125;<br>  find(argv[<span class="hljs-number">1</span>], argv[<span class="hljs-number">2</span>]);<br>  <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>find 的实现可以参考 ls 的实现，主要难点就是处理字符串获取文件名，剩下的只要递归调用一下 find 函数就可以了。</p><h3 id="5-xargs-moderate"><a href="#5-xargs-moderate" class="headerlink" title="5. xargs(moderate)"></a>5. xargs(<u>moderate</u>)</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;kernel/types.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;user/user.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;kernel/param.h&quot;</span></span><br><br><span class="hljs-type">int</span><br><span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> *argv[])</span><br>&#123;<br>  <span class="hljs-type">char</span> buf[<span class="hljs-number">512</span>];<br>  <span class="hljs-type">char</span> *x_argv[MAXARG];<br>  <span class="hljs-type">int</span> x_argc = <span class="hljs-number">0</span>;<br><br>  <span class="hljs-keyword">if</span> (argc &lt; <span class="hljs-number">2</span>) &#123;<br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-number">2</span>, <span class="hljs-string">&quot;Usage: xargs command [args...]\n&quot;</span>);<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>  &#125;<br><br>  <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">1</span>; i &lt; argc; i++) &#123;<br>    x_argv[x_argc] = argv[i];<br>    x_argc++;<br>  &#125;<br><br>  <span class="hljs-type">int</span> n = <span class="hljs-number">0</span>;<br>  <span class="hljs-type">char</span> c;<br><br>  <span class="hljs-keyword">while</span> (read(<span class="hljs-number">0</span>, &amp;c, <span class="hljs-number">1</span>) &gt; <span class="hljs-number">0</span>) &#123;<br>    <span class="hljs-keyword">if</span> (c == <span class="hljs-string">&#x27;\n&#x27;</span>) &#123;<br>      buf[n] = <span class="hljs-number">0</span>;<br><br>      <span class="hljs-keyword">if</span> (fork() == <span class="hljs-number">0</span>) &#123;<br>        x_argv[x_argc] = buf;<br>        x_argv[x_argc + <span class="hljs-number">1</span>] = <span class="hljs-number">0</span>;<br><br>        exec(x_argv[<span class="hljs-number">0</span>], x_argv);<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        wait(<span class="hljs-number">0</span>);<br>      &#125;<br><br>      n = <span class="hljs-number">0</span>;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-keyword">if</span> (n &lt; <span class="hljs-keyword">sizeof</span>(buf) - <span class="hljs-number">1</span>) &#123;<br>        buf[n++] = c;<br>      &#125;<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>xargs 的作用就是将管道左边命令的输出作为管道右边命令的参数，比如：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">find . b | grep hello<br></code></pre></td></tr></table></figure><p>这条命令只会将 <code>find . b</code> 的结果作为文本传给右边的 <code>grep hello</code> 命令,即在查找到的 b 文件的路径中去寻找是否有 hello 这个单词，再看下面使用 xargs 的命令</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">find . b | xargs grep hello<br></code></pre></td></tr></table></figure><p>这相当于将<code>find . b</code>的结果作为 <code>grep hello</code> 的参数，即在找到的 b 文件中去查找是否有 hello 这个单词。</p><hr><p>以上就是第一个 Lab: Xv6 and Unix utilities 的完成方案，最简单的 Boot xv6 我在此省略了，就是配一下环境什么的，稍微改了点东西去兼容一下我的系统，配环境网上有很多教程，我的系统也不是大家最常用的 Windows 系统，所以这里就省略了。</p><p>总体来说这个 Lab 还是十分简单，只需要阅读一下<a href="https://pdos.csail.mit.edu/6.828/2021/xv6/book-riscv-rev2.pdf">xv6 教程</a>，并了解一些系统调用的具体使用就可以比较轻松地写出来。</p>]]></content>
    
    
    <categories>
      
      <category>MIT courses</category>
      
      <category>OS</category>
      
    </categories>
    
    
    <tags>
      
      <tag>6.s081</tag>
      
      <tag>Labs</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>
